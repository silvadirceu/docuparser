# Prompt: API DocuParse Experimental â€“ OCR & Structured Extraction

## ğŸ¯ Objetivo

Desenvolver uma API em **FastAPI** (backend-ocr) para validar a extraÃ§Ã£o de dados estruturados 
de documentos complexos (Notas Fiscais, recibos e tabelas manuscritas). 
O sistema deve atuar como um roteador que seleciona a ferramenta de OCR ideal e 
retorna os dados jÃ¡ formatados em **JSON estruturado**.

## ğŸ—ï¸ Requisitos de Arquitetura (Stateless)

- **Framework:** FastAPI.
- **Sem PersistÃªncia:** NÃ£o utilizar bancos de dados ou autenticaÃ§Ã£o nesta fase.
- **Entrada:** Upload de arquivo Ãºnico (PDF, JPEG, PNG).
- **SaÃ­da:** JSON puro contendo metadados do processo e a transcriÃ§Ã£o estruturada.

## ğŸ§  Agente de ClassificaÃ§Ã£o e SeleÃ§Ã£o

O backend deve implementar uma lÃ³gica de decisÃ£o para escolher o conjunto de ferramentas baseado no input:

1. **PDF Digital (Text Layer):** Usar `pdfplumber` ou `docling` para extrair tabelas e textos preservando a coordenada.
2. **Imagens/Scans (Standard):** PrÃ©-processamento com `opencv-python` seguido de `pytesseract` ou `easyocr`.
3. **Documentos Complexos/Manuscritos:** Enviar para `llama-parse`, `unstructured` ou `deepseek-ocr` para garantir a extraÃ§Ã£o de tabelas e campos manuscritos em JSON.

## ğŸ“‹ DefiniÃ§Ã£o do JSON de SaÃ­da

A resposta da API deve seguir estritamente este formato:

```json
{
  "filename": "nf_servico_01.pdf",
  "detected_type": "handwritten_scanned",
  "tools_used": ["opencv-python", "easyocr", "llama-parse"], 
  "transcription": {
    "document_info": {
      "type": "Nota Fiscal",
      "number": "12345",
      "date": "2023-10-27"
    },
    "entities": {
      "issuer": "Empresa X LTDA",
      "recipient": "JoÃ£o Silva"
    },
    "tables": [
      {
        "description": "ServiÃ§o de Consultoria",
        "quantity": 1,
        "unit_price": 500.00,
        "total": 500.00
      }
    ],
    "totals": {
      "subtotal": 500.00,
      "tax": 25.00,
      "grand_total": 525.00
    },
    "raw_text_fallback": "Texto bruto completo aqui para conferÃªncia..."
  }
}

```

## Estrutura do Projeto

A infraestrutura inicial baseada em microserviÃ§os.

Tarefa: Gere os arquivos base para a estrutura de pastas fornecida:

```text
docuparse-project/
â”œâ”€â”€ docker-compose.yml         # OrquestraÃ§Ã£o de todos os serviÃ§os (FE, BE, OCR)
â”œâ”€â”€ .env                       # VariÃ¡veis de ambiente globais
â”œâ”€â”€ README.md                  # DocumentaÃ§Ã£o tÃ©cnica do ecossistema
â”‚
â”œâ”€â”€ frontend/                  # Projeto React + Vite (Porta 3000)
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ tailwind.config.js     # ConfiguraÃ§Ã£o Shadcn/UI [cite: 3]
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/        # UI (Dropzone, Split View, Skeletons) [cite: 3]
â”‚   â”‚   â”œâ”€â”€ pages/             # Dashboard, Login, HistÃ³rico [cite: 3]
â”‚   â”‚   â”œâ”€â”€ services/          # ConexÃ£o com a API do Django
â”‚   â”‚   â””â”€â”€ hooks/             # LÃ³gica de estado e chamadas assÃ­ncronas
â”‚
â”œâ”€â”€ backend-core/              # Django (GestÃ£o e AutenticaÃ§Ã£o - Porta 8000) 
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ manage.py
â”‚   â”œâ”€â”€ core/                  # ConfiguraÃ§Ãµes do projeto Django
â”‚   â”œâ”€â”€ accounts/              # App de AutenticaÃ§Ã£o (JWT/User) 
â”‚   â”œâ”€â”€ documents/             # App de GestÃ£o (CRUD, HistÃ³rico, Webhooks) [cite: 7, 9]
â”‚   â”‚   â”œâ”€â”€ services/          # Client para chamar a API do FastAPI
â”‚   â”‚   â””â”€â”€ models.py          # Tabelas: Users, Documents, ExtractedData 
â”‚   â””â”€â”€ requirements.txt
â”‚
â””â”€â”€ backend-ocr/               # FastAPI (Motor de IA e ExtraÃ§Ã£o - Porta 8080) 
    â”œâ”€â”€ Dockerfile
    â”œâ”€â”€ main.py                # Entrypoint FastAPI
    â”œâ”€â”€ requirements.txt
    â”œâ”€â”€ agent/                 # Agente de decisÃ£o (LÃ³gica de SeleÃ§Ã£o de OCR)
    â”‚   â”œâ”€â”€ classifier.py      # Identifica PDF Digital vs Imagem vs Manuscrito
    â”‚   â””â”€â”€ router.py          # Roteia para a melhor ferramenta
    â”œâ”€â”€ engines/               # Adaptadores para cada ferramenta
    â”‚   â”œâ”€â”€ tesseract_engine.py
    â”‚   â”œâ”€â”€ easyocr_engine.py
    â”‚   â”œâ”€â”€ docling_engine.py
    â”‚   â””â”€â”€ llamaparse_engine.py
    â””â”€â”€ utils/                 # Processamento OpenCV e manipulaÃ§Ã£o de arquivos
```

- docker-compose.yml: Configure trÃªs serviÃ§os: frontend (React), backend-core (Django) e backend-ocr (FastAPI). Use redes internas para comunicaÃ§Ã£o. 2. backend-ocr (FastAPI): Crie o main.py com o endpoint POST /process que recebe o arquivo e retorna o JSON estruturado. Inclua placeholders para as bibliotecas: opencv-python, pytesseract, easyocr, pdfplumber, docling, unstructured, llama-parse.

- backend-core (Django): Configure o settings.py bÃ¡sico e um service Python que utilize a biblioteca requests para enviar o arquivo recebido no upload para a URL do backend-ocr. 4. ComunicaÃ§Ã£o: O Django deve ser a Ãºnica porta de entrada para o usuÃ¡rio (Proxy/Gateway) para garantir a autenticaÃ§Ã£o futura. O FastAPI deve responder apenas a requisiÃ§Ãµes internas do Django.

- Requisito de SaÃ­da do OCR: O JSON final do FastAPI deve seguir o esquema de "transcription" como um objeto estruturado (Campos, Tabelas, ConfianÃ§a) e uma lista tools_used.

## ğŸ› ï¸ InstruÃ§Ãµes para o Antigravity

O objetivo do projeto atual Ã© a construÃ§Ã£o do backend-ocr.

1. **Mapeamento de Ferramentas:** Implementar um dicionÃ¡rio de "capabilities" onde cada ferramenta (ex: `unstructured` para tabelas, `pytesseract` para texto simples) Ã© chamada conforme a necessidade detectada pelo agente.
2. **NormalizaÃ§Ã£o de Tabelas:** Garanta que, independentemente da ferramenta (ex: `pdf2image` + `easyocr`), a saÃ­da de tabelas seja sempre uma lista de objetos JSON.
3. **Logs de Performance:** Inclua no console o tempo de resposta de cada motor de OCR para anÃ¡lise de custo-benefÃ­cio.
4. **Prompt de ExtraÃ§Ã£o:** Caso use LLMs (como no `llama-parse`), configure o prompt de sistema para: *"Extraia todos os dados deste documento no formato JSON, focando em chaves/valores de cabeÃ§alho e linhas de tabelas"*.
5. **instruÃ§Ãµes:** gere todas as instruÃ§Ãµes nevcessÃ¡rias para o funcionamento do sistema.
6. **DocumentaÃ§Ã£o:** gere todas as documentaÃ§Ãµes nevcessÃ¡rias para o funcionamento do sistema.
7. **Testes:** gere todos os testes nevcessÃ¡rios para o funcionamento do sistema.
8. **Deploy:** gere todos os arquivos necessÃ¡rios para o deploy do sistema.
9. **docs:** salve na pasta docs todos os passos que vocÃª utilizou para desenvolver o sistema. 
10. **Estrutura:** gere todas as estruturas de pastas necessÃ¡rias para o funcionamento do sistema.